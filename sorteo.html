<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorteo mensual La√âlite</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #admin, #loginContainer { display: none; }
    .winner { font-size: 60px; font-weight: bold; color: green; margin-top: 20px; }
    .countdown { font-size: 28px; color: red; font-weight: bold; margin-top: 15px; }
    .participant-list { margin-top: 18px; font-size: 18px; display: none; }

    #wheelContainer {
      position: relative;
      width: 400px;
      margin: 0 auto;
      display: none;
    }

    .pointer {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 30px solid red;
      position: absolute;
      top: -15px;
      left: calc(50% - 20px);
      z-index: 10;
    }

    @keyframes zoomIn {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .animate-winner {
      animation: zoomIn 1s ease-out;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.7.0/Winwheel.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDzJ04-gdIOQimkkShUs0lI6smLLtXeUcc",
      authDomain: "sorteo-ad02e.firebaseapp.com",
      databaseURL: "https://sorteo-ad02e-default-rtdb.firebaseio.com/",
      projectId: "sorteo-ad02e",
      storageBucket: "sorteo-ad02e.appspot.com",
      messagingSenderId: "505337439977",
      appId: "1:505337439977:web:8691fb960b65f98ae33278",
      measurementId: "G-ZJP53X41YY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase(app);

    let wheel;
    let countdownTimer;

    document.addEventListener("DOMContentLoaded", function () {
      const isAdmin = location.search.includes("admin");
      const adminDiv = document.getElementById("admin");
      const loginContainer = document.getElementById("loginContainer");
      const viewerDiv = document.getElementById("viewer");
      const winnerDisplay = document.getElementById("winnerDisplay");
      const participantList = document.getElementById("participantList");
      const countdownDisplay = document.getElementById("countdown");
      const startButton = document.getElementById("startButton");
      const resetButton = document.getElementById("resetButton");
      const wheelContainer = document.getElementById("wheelContainer");

      if (isAdmin) {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            adminDiv.style.display = "block";
            loginContainer.style.display = "none";
            setupAdmin();
            wheelContainer.style.display = "none"; // Oculta ruleta en modo admin
          } else {
            loginContainer.style.display = "block";
          }
        });
      } else {
        viewerDiv.style.display = "block";
        watchWinner();
        watchCountdown();
        watchParticipants();
      }

      window.login = function () {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        signInWithEmailAndPassword(auth, email, password)
          .then(() => location.reload())
          .catch((error) => alert("Error en la autenticaci√≥n: " + error.message));
      };

      window.logout = function () {
        auth.signOut().then(() => location.reload())
          .catch((error) => alert("Error al cerrar sesi√≥n: " + error.message));
      };

      function setupAdmin() {
        const userInputs = document.getElementById("userInputs");
        userInputs.innerHTML =
          '<label>Tiempo de cuenta atr√°s (segundos): <input type="number" id="countdownInput" min="5" max="300" value="10"></label><br><br>';
        for (let i = 0; i < 10; i++) {
          userInputs.innerHTML +=
            `<div>
              <input type='text' placeholder='Nombre' id='user${i}'>
              <input type='number' placeholder='Porcentaje' id='perc${i}' min='0.1' max='100' step='0.1'>
            </div>`;
        }
      }

      startButton.addEventListener("click", () => {
        startDraw();        // Esto guarda los participantes en Firebase
        startCountdown();   // Esto empieza la cuenta atr√°s
      });

      resetButton.addEventListener("click", resetDraw);

      function resetDraw() {
        remove(ref(db, "sorteo/ganador"));
        remove(ref(db, "sorteo/participants"));
        remove(ref(db, "sorteo/countdown"));

        winnerDisplay.innerText = "Aqu√≠ aparecer√° el ganador";
        countdownDisplay.innerText = "‚è≥ Tiempo restante: -- s";
        participantList.innerHTML = "";
        participantList.style.display = "none";
        wheelContainer.style.display = "none";
        wheelLaunched = false;
      }

      function startCountdown() {
        let timeLeft = parseInt(document.getElementById("countdownInput").value);
        if (isNaN(timeLeft) || timeLeft <= 0) {
          alert("Introduce un tiempo v√°lido para la cuenta atr√°s.");
          return;
        }
        set(ref(db, "sorteo/countdown"), timeLeft);
        countdownTimer = setInterval(() => {
          if (timeLeft > 0) {
            timeLeft--;
            set(ref(db, "sorteo/countdown"), timeLeft);
          } else {
            clearInterval(countdownTimer);
          }
        }, 1000);
      }

      function startDraw() {
        let participantInfo = [];
        let totalPercentage = 0;
        for (let i = 0; i < 10; i++) {
          let name = document.getElementById(`user${i}`).value.trim();
          let percentage = parseFloat(document.getElementById(`perc${i}`).value);
          if (name && !isNaN(percentage) && percentage > 0) {
            participantInfo.push({ name, percentage });
            totalPercentage += percentage;
          }
        }
      
        if (Math.abs(totalPercentage - 100) > 0.01) {
          alert("La suma de los porcentajes debe ser exactamente 100%. Corrige los valores antes de iniciar el sorteo.");
          return;
        }
      
        if (participantInfo.length === 0) {
          alert("Ingresa datos v√°lidos en los campos.");
          return;
        }
      
        // Solo guarda los participantes
        set(ref(db, "sorteo/participants"), participantInfo).then(() => {
          // Borra el ganador anterior
          remove(ref(db, "sorteo/ganador"));
          // Borra la semilla anterior
          remove(ref(db, "sorteo/seed"));
        });
      }

      function watchWinner() {
        onValue(ref(db, "sorteo/ganador"), (snapshot) => {
          const winner = snapshot.val();
          if (winner) {
            winnerDisplay.innerText = `üéâ Ganador: ${winner} üéâ`;
            winnerDisplay.classList.add("animate-winner");
          } else {
            winnerDisplay.innerText = "Esperando a la finalizaci√≥n del sorteo...";
          }
        });
      }

      function watchCountdown() {
        onValue(ref(db, "sorteo/countdown"), (snapshot) => {
          const value = snapshot.val();
          countdownDisplay.innerText = value ? `‚è≥ Tiempo restante: ${value} s` : "‚è≥ Tiempo restante: -- s";
      
          if (value === 0) {
            // Solo el admin genera la semilla
            if (isAdmin) {
              // Comprueba si ya existe una semilla para evitar duplicados
              onValue(ref(db, "sorteo/seed"), (snap) => {
                if (!snap.exists()) {
                  const seed = Math.random();
                  set(ref(db, "sorteo/seed"), seed);
                }
              }, { onlyOnce: true });
            }
            setTimeout(() => {
              watchSeedAndParticipants();
            }, 500);
          }
        });
      }

      function watchParticipants() {
        onValue(ref(db, "sorteo/participants"), (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            participantList.innerHTML = data.map(p => `<p>${p.name} - ${p.percentage}%</p>`).join('');
            participantList.style.display = "block";
          } else {
            participantList.innerHTML = "";
            participantList.style.display = "none";
          }
        });
      }

      function launchWheelWithSeed(participants, seed) {
        const total = participants.reduce((sum, p) => sum + p.percentage, 0);
      
        // Reinicia la lista de colores antes de asignar
        resetAvailableColors();
      
        if (participants.length > availableColors.length) {
          alert("Hay m√°s participantes que colores disponibles. A√±ade m√°s colores o reduce el n√∫mero de participantes.");
          return;
        }
      
        const segmentValues = participants.map(p => ({
          fillStyle: getRandomColor(),
          text: p.name,
          size: (p.percentage / total) * 360
        }));
      
        wheelContainer.style.display = "block";
      
        wheel = new Winwheel({
          canvasId: "wheelcanvas",
          drawMode: 'segment',
          numSegments: segmentValues.length,
          segments: segmentValues,
          animation: {
            type: "spinToStop",
            duration: 7,
            spins: 8,
            callbackFinished: () => {
              const indicatedSegment = wheel.getIndicatedSegment();
              const winnerName = indicatedSegment.text;
              winnerDisplay.innerText = `üéâ Ganador: ${winnerName} üéâ`;
              winnerDisplay.classList.add("animate-winner");
              set(ref(db, "sorteo/ganador"), winnerName);
            }
          }
        });
      
        // Calcula el √°ngulo de parada usando la semilla (entre 0 y 360)
        const stopAngle = seed * 360;
        wheel.animation.stopAngle = stopAngle;
        wheel.startAnimation();
      }

      let wheelLaunched = false;

      function watchSeedAndParticipants() {
        let participants = null;
        let seed = null;
      
        onValue(ref(db, "sorteo/participants"), (snap) => {
          if (snap.exists()) {
            participants = snap.val();
            tryLaunch();
          }
        });
      
        onValue(ref(db, "sorteo/seed"), (snap) => {
          if (snap.exists()) {
            seed = snap.val();
            tryLaunch();
          }
        });
      
        function tryLaunch() {
          if (participants && seed !== null && !wheelLaunched) {
            wheelLaunched = true;
            launchWheelWithSeed(participants, seed);
          }
        }
      }

      // Lista global de colores vivos (se reinicia antes de cada sorteo)
      let availableColors = [];
      
      function resetAvailableColors() {
        availableColors = [
          '#FF5733', // rojo vivo
          '#FFBD33', // naranja
          '#DBFF33', // amarillo
          '#75FF33', // verde lima
          '#33FF57', // verde
          '#33FFBD', // turquesa
          '#33DBFF', // azul claro
          '#3375FF', // azul
          '#8E33FF', // violeta
          '#FF33A8'  // rosa
        ];
      }
      
      function getRandomColor() {
        if (availableColors.length === 0) {
          alert("No hay m√°s colores disponibles para asignar. Reduce el n√∫mero de participantes o a√±ade m√°s colores.");
          return '#000000'; // Negro por defecto si se acaban los colores
        }
        const idx = Math.floor(Math.random() * availableColors.length);
        const color = availableColors[idx];
        availableColors.splice(idx, 1); // Elimina el color para que no se repita
        return color;
      }
      
    });
    
  </script>
</head>
<body>
  <h1>Sorteo del trofeo del Ranking Mensual de Clanes - BoomBang.TV</h1>
  <div id="loginContainer">
    <h2>Iniciar Sesi√≥n</h2>
    <input type="email" id="email" placeholder="Correo electr√≥nico">
    <input type="password" id="password" placeholder="Contrase√±a">
    <button onclick="login()">Iniciar Sesi√≥n</button>
  </div>
  <div id="admin">
    <h2>Preparaci√≥n del sorteo</h2>
    <div id="userInputs"></div>
    <br><button id="startButton">Iniciar Sorteo</button>
    <button id="resetButton">Borrar Sorteo</button>
    <br><button onclick="logout()">Cerrar Sesi√≥n</button>
  </div>
  <div id="viewer">
    <h2> ~ ‚òÖ Clan La √âlite ‚òÖ ~ </h2>
    <p id="countdown" class="countdown">‚è≥ Tiempo restante: -- s</p>
    <div id="participantList" class="participant-list"></div>
    <div id="wheelContainer">
      <div class="pointer"></div>
      <canvas id="wheelcanvas" width="400" height="400"></canvas>
    </div>
    <p id="winnerDisplay" class="winner">Aqu√≠ aparecer√° el ganador</p>
  </div>
</body>
</html>
