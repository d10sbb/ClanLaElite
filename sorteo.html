<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorteo mensual LaÉlite</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #admin, #loginContainer { display: none; }
    .winner { font-size: 60px; font-weight: bold; color: green; margin-top: 20px; }
    .participant-list { margin-top: 18px; font-size: 18px; display: none; }
    #wheelContainer {
      position: relative;
      width: 400px;
      margin: 0 auto;
      display: none;
    }
    .pointer {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 30px solid red;
      position: absolute;
      top: -15px;
      left: calc(50% - 20px);
      z-index: 10;
    }
    @keyframes zoomIn {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-winner {
      animation: zoomIn 1s ease-out;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.7.0/Winwheel.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDzJ04-gdIOQimkkShUs0lI6smLLtXeUcc",
      authDomain: "sorteo-ad02e.firebaseapp.com",
      databaseURL: "https://sorteo-ad02e-default-rtdb.firebaseio.com/",
      projectId: "sorteo-ad02e",
      storageBucket: "sorteo-ad02e.appspot.com",
      messagingSenderId: "505337439977",
      appId: "1:505337439977:web:8691fb960b65f98ae33278",
      measurementId: "G-ZJP53X41YY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let wheel;

    document.addEventListener("DOMContentLoaded", function () {
      const isAdmin = location.search.includes("admin");
      const adminDiv = document.getElementById("admin");
      const viewerDiv = document.getElementById("viewer");
      const winnerDisplay = document.getElementById("winnerDisplay");
      const participantList = document.getElementById("participantList");
      const wheelContainer = document.getElementById("wheelContainer");
      const startButton = document.getElementById("startButton");
      const resetButton = document.getElementById("resetButton");

      if (isAdmin) {
        adminDiv.style.display = "block";
        setupAdmin();
      } else {
        viewerDiv.style.display = "block";
        watchWinnerAndWheel();
        watchParticipants();
      }

      startButton.addEventListener("click", startDraw);
      resetButton.addEventListener("click", resetDraw);

      function setupAdmin() {
        const userInputs = document.getElementById("userInputs");
        userInputs.innerHTML = "";
        for (let i = 0; i < 10; i++) {
          userInputs.innerHTML += `
            <div>
              <input type="text" placeholder="Nombre" id="user${i}">
              <input type="number" placeholder="%" id="perc${i}" min="0.1" max="100" step="0.1">
            </div>`;
        }
      }

      function startDraw() {
        let participants = [];
        for (let i = 0; i < 10; i++) {
          const name = document.getElementById(`user${i}`).value.trim();
          const percentage = parseFloat(document.getElementById(`perc${i}`).value);
          if (name && !isNaN(percentage) && percentage > 0) {
            participants.push({ name, percentage });
          }
        }

        if (participants.length === 0) {
          alert("Por favor, ingresa datos válidos.");
          return;
        }

        const totalPercentage = participants.reduce((sum, p) => sum + p.percentage, 0);
        if (totalPercentage !== 100) {
          alert("La suma de los porcentajes debe ser igual a 100.");
          return;
        }

        set(ref(db, "sorteo/participants"), participants);

        // Crear segmentos de la ruleta
        const totalAngle = 360;
        const segments = participants.map(p => ({
          text: p.name,
          size: (p.percentage / 100) * totalAngle
        }));

        // Elegir un ángulo aleatorio para detener la ruleta
        const randomAngle = Math.random() * 360;

        // Guardar el ángulo y los participantes en Firebase
        set(ref(db, "sorteo/winner"), { angle: randomAngle });
      }

      function resetDraw() {
        remove(ref(db, "sorteo/participants"));
        remove(ref(db, "sorteo/winner"));
        participantList.innerHTML = "";
        winnerDisplay.innerText = "Aquí aparecerá el ganador";
        wheelContainer.style.display = "none";
      }

      function watchParticipants() {
        onValue(ref(db, "sorteo/participants"), (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            participantList.innerHTML = data.map(p => `<p>${p.name} - ${p.percentage}%</p>`).join("");
            participantList.style.display = "block";
          } else {
            participantList.innerHTML = "";
            participantList.style.display = "none";
          }
        });
      }

      function watchWinnerAndWheel() {
        onValue(ref(db, "sorteo/winner"), (snapshot) => {
          const winnerData = snapshot.val();
          if (winnerData) {
            launchWheel(winnerData.angle);
          }
        });
      }

      function launchWheel(stopAngle) {
        onValue(ref(db, "sorteo/participants"), (snapshot) => {
          if (snapshot.exists()) {
            const participants = snapshot.val();
            const totalAngle = 360;
            const segments = participants.map(p => ({
              fillStyle: getRandomColor(),
              text: p.name,
              size: (p.percentage / 100) * totalAngle
            }));

            wheelContainer.style.display = "block";

            wheel = new Winwheel({
              canvasId: "wheelcanvas",
              drawMode: "segment",
              numSegments: segments.length,
              segments: segments,
              animation: {
                type: "spinToStop",
                duration: 7,
                spins: 8,
                stopAngle: stopAngle
              }
            });

            wheel.startAnimation();
          }
        });
      }

      function getRandomColor() {
        const letters = "789ABCD";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * letters.length)];
        }
        return color;
      }
    });
  </script>
</head>
<body>
  <h1>Sorteo mensual LaÉlite</h1>
  <div id="admin">
    <h2>Preparación del sorteo</h2>
    <div id="userInputs"></div>
    <button id="startButton">Iniciar Sorteo</button>
    <button id="resetButton">Borrar Sorteo</button>
  </div>
  <div id="viewer">
    <p id="winnerDisplay" class="winner">Aquí aparecerá el ganador</p>
    <div id="participantList" class="participant-list"></div>
    <div id="wheelContainer">
      <div class="pointer"></div>
      <canvas id="wheelcanvas" width="400" height="400"></canvas>
    </div>
  </div>
</body>
</html>
